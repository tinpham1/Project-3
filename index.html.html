<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NASA vs SpaceX Launch Success Dashboard</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    h2 { margin-top: 40px; }
    .bar { fill-opacity: 0.7; }
    .bar:hover { fill-opacity: 1; }
    .axis-label { font-size: 14px; }
    .legend { font-size: 12px; }
    .tooltip {
      position: absolute;
      background: #333;
      color: white;
      padding: 6px;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
  </style>
</head>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<button onclick="downloadChart()">ðŸ“¥ Export Chart</button>

<script>
  function downloadChart() {
    html2canvas(document.querySelector("#chart")).then(canvas => {
      const imgData = canvas.toDataURL("image/png");
      const pdf = new jspdf.jsPDF();
      pdf.addImage(imgData, 'PNG', 10, 10, 190, 100);
      pdf.save("launch_report.pdf");
    });
  }
</script>



<form id="new-launch">
  <input type="text" name="mission_name" placeholder="Mission Name" required />
  <input type="date" name="launch_date" required />
  <input type="text" name="agency" required />
  <select name="success">
    <option value="true">Success</option>
    <option value="false">Failure</option>
  </select>
  <input type="text" name="failure_reason" placeholder="Failure Reason" />
  <button type="submit">Add Launch</button>
</form>

<script>
document.getElementById("new-launch").onsubmit = async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData);
  data.success = data.success === "true";
  data.source_id = data.agency + "__" + data.launch_date;
  await fetch("/api/launches", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  alert("Launch added!");
};
</script>



<label>Filter by Agency:
  <select id="agency-filter">
    <option value="">All</option>
    <option value="NASA">NASA</option>
    <option value="SpaceX">SpaceX</option>
  </select>
</label>

<label>Filter by Year:
  <select id="year-filter"></select>
</label>


<div style="margin-bottom: 20px;">
  <label for="agencyFilter">Filter by Agency:</label>
  <select id="agencyFilter">
    <option value="">All</option>
    <option value="NASA">NASA</option>
    <option value="SpaceX">SpaceX</option>
  </select>

  <label for="yearFilter">Year:</label>
  <select id="yearFilter"></select>

  <button onclick="loadFilteredData()">Apply Filters</button>
</div>



<script>
  function loadFilteredData() {
    const agency = document.getElementById('agencyFilter').value;
    const year = document.getElementById('yearFilter').value;

    let query = '/api/stats?';
    if (agency) query += `agency=${agency}&`;
    if (year) query += `year=${year}`;

    d3.json(query).then(renderChart);
  }

  // Populate year dropdown dynamically
  d3.json("/api/stats").then(data => {
    const years = [...new Set(data.map(d => d.year))].sort();
    const yearSelect = document.getElementById("yearFilter");
    years.forEach(y => {
      const opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      yearSelect.appendChild(opt);
    });
  });
</script>


<form id="launchForm">
  <input type="text" id="mission_name" placeholder="Mission Name" required>
  <input type="date" id="launch_date" required>
  <input type="text" id="agency" placeholder="Agency" required>
  <input type="checkbox" id="success"> Success
  <button type="submit">Add Launch</button>
</form>


<script>
  document.getElementById("launchForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const form = {
      mission_name: document.getElementById("mission_name").value,
      launch_date: document.getElementById("launch_date").value,
      agency: document.getElementById("agency").value,
      success: document.getElementById("success").checked,
      failure_reason: document.getElementById("success").checked ? null : "Unknown",
      launch_year: new Date(document.getElementById("launch_date").value).getFullYear(),
      source_id: document.getElementById("agency").value + "__" + document.getElementById("launch_date").value
    };

    fetch("/api/launches", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(form)
    }).then(resp => resp.json()).then(res => {
      alert(res.message || res.error);
      loadFilteredData(); // Refresh chart
    });
  });
</script>



<h2>Rocket Launch Animation</h2>
<svg id="rocketChart" width="1000" height="300"></svg>

<script>
d3.json("/api/launches").then(data => {
  const svg = d3.select("#rocketChart");
  const width = +svg.attr("width");
  const height = +svg.attr("height");

  const rocketScale = d3.scaleLinear()
    .domain([2000, 2025])
    .range([50, width - 50]);

  const filtered = data.filter(d => d.success !== null && d.launch_year >= 2000);

  const rockets = svg.selectAll(".rocket")
    .data(filtered)
    .enter()
    .append("g")
    .attr("transform", (d, i) => `translate(${rocketScale(d.launch_year)}, ${height - 50})`);

  rockets.append("text")
    .text("ðŸš€")
    .style("font-size", "24px")
    .attr("class", "rocket")
    .transition()
    .duration(1000)
    .attr("transform", d => `translate(${rocketScale(d.launch_year)}, ${d.success ? 100 : 200})`)
    .style("opacity", d => d.success ? 1 : 0.3);

  // Labels
  rockets.append("text")
    .text(d => d.agency)
    .attr("y", 30)
    .attr("x", -20)
    .style("font-size", "10px");
});
</script>





<body>
  <h1>NASA vs SpaceX Launch Performance</h1>
  <div id="chart"></div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    const margin = { top: 40, right: 20, bottom: 50, left: 60 },
          width = 900 - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;

    const svg = d3.select("#chart")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const tooltip = d3.select("#tooltip");

    d3.json("/api/stats").then(data => {
      const agencies = ["NASA", "SpaceX"];
      const years = [...new Set(data.map(d => d.year))];

      data.forEach(d => {
        d.success_rate = (d.success_count / d.total) * 100;
      });

      const x0 = d3.scaleBand()
        .domain(years)
        .range([0, width])
        .padding(0.2);

      const x1 = d3.scaleBand()
        .domain(agencies)
        .range([0, x0.bandwidth()])
        .padding(0.05);

      const y = d3.scaleLinear()
        .domain([0, 100])
        .nice()
        .range([height, 0]);

      const color = d3.scaleOrdinal()
        .domain(agencies)
        .range(["#1f77b4", "#ff7f0e"]);

      svg.append("g")
        .selectAll("g")
        .data(years)
        .enter()
        .append("g")
          .attr("transform", d => `translate(${x0(d)},0)`)
          .selectAll("rect")
          .data(year => agencies.map(agency => {
            const entry = data.find(d => d.year === year && d.agency === agency) || { success_rate: 0 };
            return { year, agency, value: entry.success_rate };
          }))
          .enter()
          .append("rect")
            .attr("x", d => x1(d.agency))
            .attr("y", d => y(d.value))
            .attr("width", x1.bandwidth())
            .attr("height", d => height - y(d.value))
            .attr("fill", d => color(d.agency))
            .attr("class", "bar")
            .on("mouseover", (event, d) => {
              tooltip.html(`${d.agency} ${d.year}: ${d.value.toFixed(1)}% success`)
                .style("left", event.pageX + "px")
                .style("top", event.pageY - 30 + "px")
                .style("opacity", 1);
            })
            .on("mouseout", () => tooltip.style("opacity", 0));

      svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x0))
        .selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end");

      svg.append("g")
        .call(d3.axisLeft(y).tickFormat(d => d + "%"));

      const legend = svg.append("g")
        .attr("transform", `translate(${width - 100}, 10)`);

      agencies.forEach((agency, i) => {
        legend.append("rect")
          .attr("x", 0)
          .attr("y", i * 20)
          .attr("width", 15)
          .attr("height", 15)
          .attr("fill", color(agency));

        legend.append("text")
          .attr("x", 20)
          .attr("y", i * 20 + 12)
          .text(agency)
          .attr("class", "legend");
      });
    });
  </script>
</body>
</html>
