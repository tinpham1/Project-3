<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NASA vs SpaceX Launch Success Dashboard</title>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    h2 { margin-top: 40px; }
    .bar { fill-opacity: 0.7; }
    .bar:hover { fill-opacity: 1; }
    .axis-label { font-size: 14px; }
    .legend { font-size: 12px; }
    .tooltip {
      position: absolute;
      background: #333;
      color: white;
      padding: 6px;
      border-radius: 4px;
      font-size: 12px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }
  </style>
</head>
<body>
  <h1>NASA vs SpaceX Launch Performance</h1>
  <div id="chart"></div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    const margin = { top: 40, right: 20, bottom: 50, left: 60 },
          width = 900 - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;

    const svg = d3.select("#chart")
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const tooltip = d3.select("#tooltip");

    d3.json("/api/stats").then(data => {
      const agencies = ["NASA", "SpaceX"];
      const years = [...new Set(data.map(d => d.year))];

      data.forEach(d => {
        d.success_rate = (d.success_count / d.total) * 100;
      });

      const x0 = d3.scaleBand()
        .domain(years)
        .range([0, width])
        .padding(0.2);

      const x1 = d3.scaleBand()
        .domain(agencies)
        .range([0, x0.bandwidth()])
        .padding(0.05);

      const y = d3.scaleLinear()
        .domain([0, 100])
        .nice()
        .range([height, 0]);

      const color = d3.scaleOrdinal()
        .domain(agencies)
        .range(["#1f77b4", "#ff7f0e"]);

      svg.append("g")
        .selectAll("g")
        .data(years)
        .enter()
        .append("g")
          .attr("transform", d => `translate(${x0(d)},0)`)
          .selectAll("rect")
          .data(year => agencies.map(agency => {
            const entry = data.find(d => d.year === year && d.agency === agency) || { success_rate: 0 };
            return { year, agency, value: entry.success_rate };
          }))
          .enter()
          .append("rect")
            .attr("x", d => x1(d.agency))
            .attr("y", d => y(d.value))
            .attr("width", x1.bandwidth())
            .attr("height", d => height - y(d.value))
            .attr("fill", d => color(d.agency))
            .attr("class", "bar")
            .on("mouseover", (event, d) => {
              tooltip.html(`${d.agency} ${d.year}: ${d.value.toFixed(1)}% success`)
                .style("left", event.pageX + "px")
                .style("top", event.pageY - 30 + "px")
                .style("opacity", 1);
            })
            .on("mouseout", () => tooltip.style("opacity", 0));

      svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x0))
        .selectAll("text")
        .attr("transform", "rotate(-45)")
        .style("text-anchor", "end");

      svg.append("g")
        .call(d3.axisLeft(y).tickFormat(d => d + "%"));

      const legend = svg.append("g")
        .attr("transform", `translate(${width - 100}, 10)`);

      agencies.forEach((agency, i) => {
        legend.append("rect")
          .attr("x", 0)
          .attr("y", i * 20)
          .attr("width", 15)
          .attr("height", 15)
          .attr("fill", color(agency));

        legend.append("text")
          .attr("x", 20)
          .attr("y", i * 20 + 12)
          .text(agency)
          .attr("class", "legend");
      });
    });
  </script>
</body>
</html>
